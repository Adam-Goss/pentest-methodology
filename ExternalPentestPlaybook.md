# External Pentest Playbook

Preparation:
- have checklists to go through for pentests and spreadsheets to keep track of information found
- make sure rules of engagement are clearly defined and signed by client 
- make sure to verify scope of engagement (i.e. check IP address given is actually owned by company)
- send kickoff email

Kicking off: 
- likely to get in through weak (or leaked) credentials, not an RCE
- start by doing a vulnerability scan and then parsing this (i.e. using a Nessus parser) into a nice format 


OSINT:
- next, move onto OSINT
- hunt breached credentials (i.e. GItHub breach-parse, dehashed.com) -- identify current format of usernames/email addresses, identify password patterns, recursively search for accounts
- identify employees/usernames and emails (i.e. hunter.io, phonebook.cz, clearbit Chrome extension, LinkedIn)
- enumerate any account on portals (pre-attack) -- find all login portals, try credentials and check for error message (captcha? says invalid username or invalid password? password reset functionality?)
- identify client's website and search for any useful data to help attack (job postings for technologies in-use, system information, password policy, etc.)


Attacking login portals:
- you should have identified all login portals to attack, have a list of possible employees/emails, and have password strategies to employ (based on the password policy in-use)
- the majority of corporations use O365 (or other Microsoft products) because they tie in nicely with Active Directory; hence if you get valid credentials you can try to re-use them everywhere in the domain.
- attempt password spraying against O365 (cloud-based office option) with TREVORspray:
	- i.e. `trevospray.py -e valid_emails.txt --passwords 'Winter20!' --delay 10 --no-current-ip --ssh ubuntu@100.25.28.206 ubuntu@67.125.208.3 ubuntu@12.5.2.20 ubuntu@120.1.222.6 ubuntu@93.125.28.206 ubuntu@10.5.2.26 ubuntu@11.23.171.239 -k hacking.pem`
	- use only valid emails, try password "Winter20!", delay for 10s, use one of the proxy IP addresses provided (i.e. ubuntu@100.25.38.206) so you don't get blocked, with SSH key "hacking.pem" to SSH into proxy addresses
	- check all errors other than "invalid login" as they may be valid logins
	- you must know the lock out policy before beginning (define in scope) so you don't lock everyone in the corporation out
	- for the proxy addresses setup an AWS Ubuntu instance, try to SSH into that machine to make sure it works, then use the public IP address provided as a proxy address
	- once you have a valid O365 login you can enumerate emails in Outlook and files in OneCloud/Sharepoint/OneNote/Teams
	- methodology = use weak passwords against valid emails 
- attempt password spraying against OWA (on-premise office options) with Metasploit:
	- i.e. `use auxiliary/scanner/http/owa_login` -> set the password, rhost, and username/user_file (could also stop_on_success and threads options) -- you may need to change OWA version in the Auxiliary Options
	- this will tell you if a username if valid and the domain name if a successful login occurs
- attempt password spraying against non-Microsoft login portals with Burp:
	1. identify login portal 
	2. use Burp suite to target login portal's URL (add to Scope)
	3. use Burp to intercept a login request and send request to Intruder
	4. setup Options in Intruder to capture page content returned when a failed login occurs (i.e. grep for "invalid email address", a status code of 200, etc.) 
	5. setup Payloads settings to use a list of valid usernames or weak passwords (a Simple List) and then run the Sniper attack 
	6. sort by Status code, Length, etc. to filter for valid logins 
	- you can do other attacks in Burp like a credential stuffing attack (i.e. Pitch Fork) where you use usernames and password combinations
- bypassing MFA:
	- typically external pentests don't use social engineering, so are limited in their options for trying to bypass MFA
	- MFASweep is a tool that you can use to go through Microsoft login services and check if MFA is being used for an account (i.e. `. .\MFASweep.ps1` -> `Invoke-MFASweep -Username <account> -Password <password>`)
	- O365 EWS can be bypassed using the tool MailSniper (i.e. `. .\MailSniper.ps1` -> `Invoke-SelfSearch -Mailbox <account> -ExchHostname <exchange_hostname> -remote`)


Escalating access:
- once you have initial access, you want to begin trying to escalate your access by enumerating everything you can find
- a common foothold is an Office account -- here you can look through emails for credentials, VPN information, account setup information
- you can look through Sharepoint for sensitive files tor credentials hat are being shared with this account
- trying logging in to azure.portal.com with the account you have access to -- if successful you can dump out sensitive user information (which can then be used in a password spray attack) or if misconfigured you can add/remove users
- retry passwords/credentials you have previously found and use passwords/credentials found for credentials stuffing attacks against other users
- if you find another account then repeat the process of enumerating it and trying to escalate access 


Report writing:
- be clear that the report is a snapshot in time and not all findings were found due to time limitations 
- include impact of findings (i.e. CVSS score)
- include recommendations/remediation for fixing/preventing the findings/vulnerabilities
- have an executive summary section which provides a high-level overview of critical/high findings and a technical findings section that provides technical details and proof screenshots (annotated)
- provide references for findings (i.e. CVEs, NIST recommendations, OWASP definitions, etc.)
- note security strengths (i.e. when detected or blocked) and security weaknesses
- used borders, keep backgrounds light (i.e. invert terminal colours), and have clean formatting 
- provide additional scans and reports (i.e. nmap/nessus scans, list of all compromised/breached accounts, etc.)


Common pentest findings:
- **insufficient authentication controls**:
	- usually occurs when MFA is not enabled or can be bypassed
	- usually high/critical severity if you can gain access to an account through a login portal
	- recommend; migrating on-premise exchange to O365, using a VPN to access internal services, using MFA (either on everything or properly)
	- if you're unable to test MFA then ask the client and include this in report
- **weak password policy**:
	- weak password policy can be discovered through password spraying (i.e. if you break in with "Winter1")
	- weak password policy can be discovered through organisational documents or through OSINT or through account signup 
	- recommend; using password deny lists for passwords that have been found in breaches or are too common, following NIST guidelines 
	- if you're unable to identify the password policy then you can ask the client and include this in the report
- **insufficient patching**:
	- these findings can vary in range (high/moderate/low) as it can range from out-of-date software to software with a known CVE
	- if exploit exists then show running the exploit and results of (unlikely to see RCE)
	- Nessus (or other vulnerability scanners) should pickup patch issues or out-of-date software running
	- recommend; include vendor patch/mitigation 
- **default credentials**:
	- default credentials exist on things like routers, switches, WAPs, software logins, etc. and you should always check default credentials for admin account
	- more typically found on internal pentests 
	- usually a high finding
- **insufficient encryption**:
	- very common, includes; HTTP running instead of HTTPS, weak/moderate ciphers running (i.e. TLS 1.0, SSL 2/3, POODLE, SWEET32, RC4), self-signed certificates -- picked up on Nesses scan
	- chance of exploitation is low (required MITM) but impact can be high for some things
	- create a table of ciphers / weak encryption being used and mark it against the IP addresses tested in report (or create an excel document if lots of IP addresses)
	- recommend; migrating everything over to HTTPS, disabling weak ciphers on public web servers
- **information disclosure**:
	- can range from critical to low and shows up in many different forms 
	- includes; improper error handling that may disclose usernames or domain information, mDNS information closure, server response headers, verbose error messages (try generating errors)
	- recommend; disabling verbose error messages, sanitizing server response headers, etc.
- **username enumeration**:
	- commonly found during login portal attacks (i.e. OWA, O365, alternative login portals)
	- also found with "forgot password" features when it returns a "valid" or "invalid" message for the username provided -- should just say to check your inbox
	- usually a low severity (unless chained with other findings, like weak passwords)
- **default web pages**:
	- usually a Apache or IIS server web page
	- this signifies bad hygiene to an attacker (i.e. the corporation doesn't care what they are showing) or that the corporation is hiding something behind this default web page 
	- recommend; not running default web pages and replacing with terms of service 
- **open mail relays**:
	- this is a misconfiguration in a mail server that lets you perform mail relays from external source addresses to internal destination address or internal to internal (i.e. used in phishing attacks)
	- becoming less common, but still exist usually as half-open mail relays
	- some ISPs block your 25 outbound connection so you may need to ask them to open it up 
	- reference: https://www.blackhillsinfosec.com/how-to-test-for-open-mail-relays/
- **IKE with aggressive mode enabled**:
	- usually low severity and shows up on Nessus scans (or with `ike-scan` tool)
	- with aggressive mode enabled you could theoretically capture the pre-shared key of a VPN and use this to gain access to the internal network -- very unlikely (a CVE from 2002)
	- recommend; best practice to have IKE aggressive mode disabled 
- **unexpected perimeter services**:
	- includes services like RDP or telnet -- things you don't expect to see facing the outside or are not behind a VPN, and that would provide direct access to the internal environment
	- ask the client why they have this service public facing and validate their reasoning 
	- ranges between low and high severity
- **insufficient traffic blocking**:
	- this is not always applicable as a finding, it depends on the client and their traffic 
	- check with the organization if access is required globally and run the tool "Shotsherpa" (accesses a resource from different locations around the world) to see if the organization if accessible globally or not 
	- limiting geo-location access reduces the organization's attack surface and you should work with client to do this 
	- this is client dependent because they may want traffic coming from different locations to reach their resources 
- **undetected malicious activity**:
	- most clients detect some malicious activity and miss some 
	- continue the conversation past the pentest by listing attacks that went undetected and tests that were detected so they can see their coverage 
	- some attacks are more difficult to detect but should be noted for information and review
	- recommend; reviewing SIEM strategy for external networks
- **historical account compromise**:
	- when gathering compromised account information during OSINT, you should keep track of it and provide it to the client (make sure to obfuscate passwords)
	- recommend; training users to avoid password reuse, not using work emails to signup for sites, enforcing password rotation with strict password complexity requirements, subscribing to "haveibeenpwned.com" to be proactive about monitoring compromised corporate accounts


Wrapping up:
- client debrief: keep it a high-level overview, but there is likely to be a mix of high-level and technical questions, keep it positive and try to educate the client 
- attestation letter = typically a one-page letter you provide after a pentest that summarizes the engagement (a overview of the executive summary)
- retesting = 30-90 day period you offer the client to retest their environment after they have patched something, you then go back and mention in report that the finding has been remediated 


	


