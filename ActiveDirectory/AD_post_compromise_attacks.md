# Active Directory: Post-Compromise Attacks

---

### PowerView 

> PowerView is a PowerShell tool to gain network situational awareness on Windows domains. It contains a set of pure-PowerShell replacements for various windows "net \*" commands, which utilize PowerShell AD hooks and underlying Win32 API functions to perform useful Windows domain functionality. It can be downloaded from https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon

PowerView Cheat Sheet: https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

First download PowerView to machine:
- see [[file_transfers]] or [[powershell]]

Domain Enumeration with PowerView:
1. run PowerShell with execution bypass from command prompt:
	- `powershell -ep bypass`
2. load the PowerView script:
	- `. .\PowerView.ps1`
3. enumerate basic domain information by running modules:
	- `Get-NetDomain` -- name of domain
	- `Get-NetDomainController` -- where domain controller is 
	- `Get-DomainPolicy` -> `(Get-DomainPolicy)."SystemAccess"`  -- to get information about the "SystemAccess" policy (i.e. minimum password length)
4. enumerate user information:
	-	`Get-NetUser` -> `Get-NetUser | select cn` -- to get a list of users 
	-	`Get-NetUser <username>` -- to get information about a specific user 
	-	`Get-NetUser | select cn,pwdlastset` -- to get when user last set their password 
	-	`Get-NetUser | select cn,logoncount` -- to get how many times a user has logged in (useful for detecting honeypot accounts where a user has never logged in)
	-	`Get-NetUser | select cn,badpwdcount` -- to get how many failed logins an account has
5. enumerate computer information: 
	-	`Get-NetComputer` -> `Get-NetComputer| select cn` -- to get a list of computers
	-	`Get-NetComputer <computer_name>` -- to get information about a specific computer 
	- `Get-NetComputer | select OperatingSystem` -- to filter by OS
6. enumerate group information:
	- `Get-NetGroup` 
	- `Get-NetGroup -Name "Domain Admins"`-- to get information about the "Domain Admins" group
	- `Get-NetGroup -Name *admin*` -- to get all admin groups
	- `Get-NetGroupMember -Name "Domain Admins"` -- to get a list of all users who are part of the "Domain Admins" group 
7. enumerate SMB share information:
	- `Invoke-ShareFinder` -- to find shares to explore
8. enumerate group policy information:
	- `Get-NetGPO` -- to get all group policies 
	- `Get-NetGPO | select displayname, whenchanged` -- to get more concise information 

<br>

### Bloodhound 

> Bloodhound is a tool that downloads the data of Active Directory and provides a visual representation of this data in a graph. It quickly digests information and figures out the path required to get to Domain Admin.

Installation and startup:
1. install: `sudo apt update && sudo apt install bloodhound`
2. configure neo4j:
	- `sudo neo4j console` and navigate to localhost link
	- connect to console using username: "neo4j" and password: "neo4j"
	- change the default password 
3. in a new tab run `bloodhound` and login with the password you created as neo4j user


Grab data with an ingestor: 
> This can be done with `Invoke-Bloodhound` (PowerShell), SharpHound (C#), or with Python 

With Bloodhound:
1. grab the `Invoke-Bloodhound` Powershell script
	- i.e. https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1
2. run PowerShell with execution bypass from command prompt:
	- `powershell -ep bypass`
2. load the SharpHound script:
	- `. .\SharpHound.ps1`
3. collect data
	- `Invoke-BloodHound -CollectionMethod All -Domain MARVEL.local -ZipFilename file.zip`
	- collects all the data from the "MARVE.local" domain and puts it in "file.zip"


Enumerating domain data:
1. transfer data collected (zip file) to Kali machine where bloodhound is installed
2. on the bloodhound interface click Upload Data and select the zip file 
3. once uploaded you can run "Pre-Built Analysis Queries" from the Analysis tab:
	- Find All Domain Admins
	- Find Shortest Path to Domain Admins
	- Find Shortest Path to High Value Targets
4. once you have access to a new machine, re-run bloodhound and upload the new data to find more paths  




