# SMTP (25)

---

### 1) SMTP Enumeration

Enumerate with nmap:
- ` nmap --script smtp-commands,smtp-enum-users,smtp-ntlm-info,smtp-open-relay -Pn -oN nmap/smtpEnum -p 25,465,587 $IP`

Check for vulnerabilities with nmap:
- ` nmap --script smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -Pn -p 25,465,587 -oN nmap/smtpVuln $IP`

Find SMTP options/verbs enabled on server:
- with nmap NSE: `nmap --script smtp-commands <ip_address> -p 25`
- with netcat: `nc -v <ip_address> 25` + `help` + `<Enter>`
- with telnet: `telnet <ip_address> 25` + `help` + `<Enter>`

Manually verify existing users on a mail server:
- `nc -nv <target> 25` -> `VRFY <account>`
- i.e `nc -nv 10.11.1.217 25` -> `VRFY root`
- or use a Python script:
	```python
	#!/usr/bin/python
	import socket
	import sys
	if len(sys.argv) != 2:
	print "Usage: vrfy.py <username>"
	sys.exit(0)
	# Create a Socket
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	# Connect to the Server
	connect = s.connect(('10.11.1.217',25))
	# Receive the banner
	banner = s.recv(1024)
	print banner
	# VRFY a user
	s.send('VRFY ' + sys.argv[1] + '\r\n')
	result = s.recv(1024)
	# Close the socket
	s.close()
	```
	

Enumerate SMTP usernames with smtp-user-enum:
- to test all methods using list: `smtp-user-enum -U <user_list> -t <target>`
- to test single username against list of targets: `smtp-user-enum -u <username> -T <target_list>`
- to test individual method (`RCPT`, `EXPN`, and `VRFY`): `smtp-user-enum -M <method> ...`

To brute force SMTP users with nmap NSE:
- `nmap --script=smtp-brute -p 25 <target>`

To brute force SMTP users with Metasploit:
- `use auxiliary/scanner/smtp/smtp_enum` -> set options -> `set USER_FILE users.txt` -- from the output you can create a new list of `valid_users.txt`


<br> 

### 2) SMTP Exploitation

SMTP shellshock:
> Postfix SMTP 4.2.x < 4.2.48 are vulnerable to 'Shellshock' Remote Command Injection.
- a) check SMTP version
	- `nmap -sV <target> -p 25`
	- `nc -nv <target> 25`
- b) exploit:
	- execute commands with: https://www.exploit-db.com/exploits/34896
	- get a reverse shell with:  https://github.com/3mrgnc3/pentest_old/blob/master/postfix-shellshock-nc.py
