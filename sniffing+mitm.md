# Sniffing & MiTM Attack

--- 

> Once you have compromised a machine you can start sniffing it's packets to see if you can pivot to other machines on the network or internally.

### Passive Sniffing
>  These attacks where an attacker just "watches" packets on a network in order to gather sensitive information such as userids, passwords, and other sensitive information 
>  These attacks are difficult to detect due to their "hands off" approach and the only tool you need to perform them is a sniffer (i.e. Wireshark, tcpdump, Metasploit, etc.)

In Meterpreter:
1. get system privileges on the system
2. `load sniffer`
3. `sniffer_start <iface_id>`
4. `sniffer_stop <iface_id>`
5. `sniffer_dump <iface_id> <file>`
6. load results in Wireshark 


With Wireshark:
1. select an interface (and possibly capture filter)
2. pick a log file to save your results to (under Capture Options)
3. start the capture 
4. filter packets (either by writing the filter in the filter field or clicking on Expression)
	- i.e. if your looking at a web application that uses basic the HTTP authentication mechanism you can use the `http.authbasic` filter to list all the packets containing credentials sent to the application
5. study the packets (right click on a packet and select "Show Packet in a New Window")
	- i.e. if basic HTTP authentication is used look for the child node named *Authroization: Basic \<string\>* and look for the *Credentials* line, to see the credentials used for the authentication


With tcpdump:
- basic syntax: `tcpdump [options] [filter expression]`
- to list available interfaces to use: `sudo tcpdump -D`
- i.e. to see all traffic on the main network interface (eth0): `sudo tcpdump -i eth0`
- to disable tcpdump's default behavior of converting IP addresses to DNS names use the `-n` argument, to get a quieter output use the `-q` option, or to run in verbose mod use `-v`
- tcpdump filter options:
	- to filter traffic to/from a specific host (i.e. elsfoo.com): `sudo tcpdump -i eth1 host elsfoo.com` 
	- to filter traffic going from a specific source to a specific destination: `sudo tcpdump -i eth1 src <source_ip> dst <destination_ip>`
	- to import a file as a filter: `sudo tcpdump -i eth1 -F <filter_filename>`
		- i.e. the filter file can contain things like `port 80`, `host elsfoo.com`, `src 192.168.12.2`, etc. 
- to stop capturing packets after a certain amount use the `-c <packet_limit>` option
	- i.e. `sudo tcpdump -i eth1 -c 150` to stop capturing after 150 packets
- to export and save a packet capture use `-w <output_filename>`, you can then view this traffic in tcpdump with `sudo tcpdump -i eth1 -r <filename>` or view it with Wireshark (if saved as a .pcap file)
- tcpdump can be used with bash scripts/commands to expand it's power:
	- i.e. to grep packets that contain IP 192.168.1.1 from a packet capture: `sudo tcpdump -i eth1 | grep 192.168.1.1`
-  to reduce the amount of traffic and inspect on the communications with host 192.168.102.139: `sudo tcpdump -i eth0 -xxAXXSs 0 dst 192.168.102.139`
		- the `-s 0` option sets the MTU size to 0 to capture the entire packet
- i.e. for simpler output: `sudo tcpdump -i eth0 -vvvASs 0 dst 192.168.102.139`
		- this removes all the hexadecimal output, but increases the output verbosity with the `-vvv` argument 
- Wireshark will automatically decode the base64 encoded text in a packet for you, whereas you have to do this manually with tcpdump (i.e for the *Authorization* header in basic HTTP authorization)
	- i.e. to decode on the command line: `echo <base64_string> | base64 -d`


### Active Sniffing
> These attacks are performed by actively performing (malicious) operations (i.e. MAC flooding or ARP poisoning) on the network -- this means injecting packets onto the network in order to redirect the traffic (this is not a stealthy technique).


**MAC Flooding**
> This technique is where one floods a switch and fills it's CAM table (the table which contains all the information required to forward frames to the correct port: *\<MAC address - port - TTL\>*). When the CAM is filled with fake MAC addresses, the switch cannot learn new MAC addresses and the only way to keep the network alive is to forward the frames meant to be delivered unknown MAC addresses to all ports of the switch, thus making it fail open or act like a hub.

With Macof:
- macof is a C version of the Perl module Net::RawIP macof program and like many other tools for the best results it must be run an administrator/root user
-  macof can generate 155,000 MAC entries per minute, and generally takes less than 70 seconds to fill the CAM table of an average switch 
-  basic usage: `macof [-s src] [-d dst] [-e tha] [-x sport] [-y dport] [-i interface] [-n times]`
	- ![[macof_options.png]]
	- running macof may cause degradation of network services
	- ensure that IP forwarding is active on the attacking machine before running (i.e. `echo 1 > /proc/sys/net/ipv4/ip_forward`)
- i.e. `sudo macof -i tap0` -- runs maco on interface *tap0*
	- with macof running you can start a network sniffer (i.e. Wireshark) and capture the data coming from the switch 
	- if you are not seeing data from other systems, then the router or switch you are trying to flood probably has protection against MAC flooding 
- i.e. `sudo macof -i tap0 -n 32` -- to send 32 packets and then stop
	- this will only replace the first 32 listings in the CAM, and would only get data from those ports until the switch times out the entry in the table and re-discovered the IP address of the device attached to the port


<br>

**ARP Poisoning** (a.k.a ARP spoofing)
> This technique is probably the stealthiest among the active sniffing techniques as it does not require bringing down switch functionalities, instead it exploits the concept of traffic redirection. It is used in most MitM attacks and involves the attacking exploiting the network to redirect traffic of the selected victim to a specific machine (usually the attacker's machine) and doing so enables the attacker to both monitor and modify the traffic.

With Responder & MultiRelay:
- [Responder](https://github.com/lgandx/Responder) is an excellent tool that an be utilised for exploiting the LLMNR and NBT-NS weakness for capturing NTLMv1/v2 hashes and relaying them for authentication to other systems 
- Responder works by listening for LLMNR or NBT-NS broadcast messages and spoofing responses to targeted hosts, which results in the interception of hashes you can either pass (relay) to other systems or crack offline 
- the [MultiRelay](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py) tool can be used in conjuction with Responder to relay the hashes to other machines on the LAN and can provide us with a MultiRelay shell if successful
- it is important to note, for this attack to work [SMB Signing](https://support.microsoft.com/en-us/help/887429/overview-of-server-message-block-signing) must have been disabled on the workstations. For determining whether or not SMB Signing is enabled on a target, you can use the [RunFinger.py](https://github.com/lgandx/Responder/blob/master/tools/RunFinger.py) tool (which is also included with the Responder toolkit) with the `-i` siwtch (i.e. `python RunFinger.py -i <target_ip>`)
- the steps for launching an attack are generally as follows:
	1. modify the `Resonder.conf` configuration file and disable `SMB` server and `HTTP` server options by setting the values to `Off`
	2. launch `Responder.py` with the `-I` (interface) optoin and the `--lm` option to downgrade NTLMv1 or v2 to LM hashes where supported: `python Responder.py -I <iface> --lm` -- Responder will begin responding to LLMNR and NBT-NS requests 
	3. in another window, launch the `MultiRelay.py` tool (found within the Tools directory of the Responder package) and a specify a target name with `-t` and use the `ALL` with the `-u` switch: `python MultiRelay.py -t <target_ip> -u ALL`
- a successful hash relay will result in a MultiRelay "shell" where you an use a number of built-in options or execute your own commands for furthering the foothold (i.e. uploading a fully functional shell)


With Ettercap:
- Ettercap is an open source program that combines a packet sniffer for different protocols (POP/HTTP/HTTPS/SFTP) and password cracking features, that can be used to perform active sniffing and MitM attacks
1. to start ettercap: `sudo ettercap -G` (with `-G` instructing ettercap to use GTK+ GUI (start in graphical mode)) -> then choose the interface to use and the sniffing option
2. select a sniffing mode:
	- *unified* = it sniffs all the packets on the cable 
	- *bridged* = it uses two network interfaces and forwards the traffic from one to the other 
3. once you start sniffing, you can see the connections intercepted by clicking on "View" and selection "Connections" 
4. scan the network for alive hosts:
	- click on "Hosts" -> then click "Scan for Hosts"
	- once complete click on "Host list" in the "Host" menu and you can select a host to target for an attack -- the more hosts you pick, the more traffic that needs to be processes 
	- if you only want to intercept traffic of a specific host, add the target host and the router in the list (i.e. "Add to target 1": 172.15.2.42 and "Add to target 2": 172.15.2.1)
	- if you do not select any targets, then Ettercap will automatically set ANY (all the hosts) in the target list and this could DoS your network if your computer cannot process that amount of traffic 
5. select  the type of attack to run by clicking on the "MitM" bar and choosing either; ARP poisoning, ICMP redirect, port stealing, or DHCP spoofing
	- selecting an attack will result in a pop-up window where you can select some options for the attack
	- i.e. select "ARP poisoning" -> select "Sniff remote connections" in the pop-up window -> and verify the attack worked by check the attacking machine's MAC address and comparing it to the ARP table of the victim machine 
6. once you start an attack (and you know it's working) you can click on "View" -> "Connections" to inspect the intercepted traffic 
	-  to inspect the packets, double click on a connection listed and a new tab will appear 
	-  Ettercap will automatically try to intercept credentials sent via the network and display these 
	-  if the traffic is encrypted (i.e. SSL), then you will not be able to read intercepted credentials 


With Bettercap:
-  Bettercap is an open source, modular, multi-platform tool that offers a great amount of options and features to perform a highly configured MitM attack 
- like other tools, bettercap implements an *ARP spoofer* feature that allows you to target both the whole network or a single known address 
- to view available options: `bettercap -h`
- firsly, to find targets in the network run bettercap with hte `--no-spoofing` option: i.e. `bettercap -I tap0 --no-spoofing`
	- by default, this will discover hosts and perform a NBNS hostname resolution for each host, but this can be disabled using the `--no-target-nbns` option 
- running bettercap without any options will, by default, run a spoofing attack against all the hosts in the network -- you can use the `-T` option to specify a specific host to target
	- i.e. `bettercap -I tap0 -T <target_ip>`
- if bettercap does not automatically identify the correct gateway, or if you want to manually specify a different gateway address, you can use the `-G` option
	- i.e. `bettercap -I tap0 -G <gateway_ip> -T <target_ip>`
- to enable bettercap's sniffer feature use the `-X` option. The credential sniffer is able to dissect and print information such as; URLs visited, HTTP POST data, HTTP authentications, FTP credentials, and more
- you can decide what data you want to analyse (i.e. HTTPAUTH, FTP, URL, POST) using the `-P` (packet parser) option or filter through all the sniffed data (i.e. `-P "*"`)
- i.e. `bettercap -I tap0 -T <target_ip> -X -P "HTTPAUTH,FTP,URL,POST"`
- this is a very simple tool that offers many other interesting features, such as being able to using the `--proxy-https` option to run "sslstrip" which strip away SSL encryption by injected a self-signed SSL certificate into the connection 

With MITMf:
- MITMf is a tool which implements a HSTS bypass attack
- to view its manual: `python mitmf.py -h`
- the options and plugins to use for this type of attack are:
	- ![[mitmf_options.png]]
- i.e. `python mitmf.py -i <iface> --spoof --arp --dns --hsts --gateway <gateway_ip> --targets <target_ip>`
- with the attack running, if a victim tries to login to a service then the tool will sniff this traffic and show their username and password